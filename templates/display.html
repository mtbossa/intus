<!DOCTYPE html>
<html lang="pt_BR">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <style>
            * {
                padding: 0;
                margin: 0;
                overflow: hidden;
            }

            body {
                display: flex;
            }

            #slider img, video {
                visibility: hidden;
                position: absolute;
                width: 100vw;
                height: 100vh;
            }

            #slider img.selected, video.selected {
                visibility: visible;
                position: absolute;
            }

        </style>

    </head>
    <body>

        <div id="slider">
            {% for post in posts %}
                {% if post.media_type == 'image' %}
                    <img id="{{ post.post_id }}" src="{{ post.local_path }}" alt="{{ post.media_name }}">
                {% else %}
                    <video id="{{ post.post_id }}" width="1920" height="1080" muted>
                        <source src="{{ post.local_path }}" type="video/mp4">
                    </video>
                {% endif %}
            {% endfor %}
        </div>

    </body>

    <script>        
        window.addEventListener('load', (event) => {

            const posts = {{ posts|safe }}
            console.log(posts)
            const currentAmountOfPosts = posts.length;

            let firstTime = true;
            let currentMediaIndex = 0;
            let mediaElements = document.querySelectorAll("#slider img, video");
            let amountOfMedia = mediaElements.length;

            function nextPost()
            {
                if(mediaElements[currentMediaIndex].tagName == 'IMG') {
                    console.log('inside media');
                    mediaElements[currentMediaIndex]
                        .classList.add("selected");   
                    console.log('inside next post');
                    let post = posts[currentMediaIndex];
                        
                    let duration = post.media_duration;
                    console.log(duration);
                    setTimeout(function() {
                        mediaElements[currentMediaIndex]
                            .classList.remove("selected");

                        currentMediaIndex++;

                        if(currentMediaIndex >= amountOfMedia) {
                        currentMediaIndex = 0;
                        }

                        nextPost();
                    }, duration);

                } else if(mediaElements[currentMediaIndex].tagName == 'VIDEO') {

                    mediaElements[currentMediaIndex]
                        .classList.add("selected");

                    var vid = mediaElements[currentMediaIndex];
                    
                    vid.play();
                }                
            }

            function addEventToVideo(video)
            {
                video.addEventListener('ended', function(e) {  
                    mediaElements[currentMediaIndex]
                        .classList.remove("selected");

                    currentMediaIndex++;

                    if(currentMediaIndex >= amountOfMedia) {
                        currentMediaIndex = 0;
                    } 

                    nextPost();
                });
            }

            const videos = document.querySelectorAll('video');  
            if(videos.length > 0) {                        

                videos.forEach(function(video) {
                    addEventToVideo(video);
                });
                nextPost();
            } else {
                nextPost();
            }

        });
    </script>

</html>
